---
version: "3"

tasks:
  init:
    desc: "Initializes Sealed Secrets by fetching the public cert from the cluster (run once per cluster)"
    cmds:
      - |
        echo "Waiting for Sealed Secrets controller to become available in kube-system..."
        kubectl -n kube-system rollout status deployment/sealed-secrets-controller --timeout=2m
        echo "Fetching public certificate..."
        kubeseal --fetch-cert --controller-namespace kube-system > .sealed-secrets-public-cert.pem
        echo "✅ Public certificate saved to .sealed-secrets-public-cert.pem"
        echo "You can now seal secrets using 'task secrets:seal'"
    generates:
      - .sealed-secrets-public-cert.pem
    preconditions:
      - msg: "kubectl must be installed and configured to connect to your cluster."
        sh: "command -v kubectl"
      - msg: "kubeseal must be installed. Run the postCreateCommand.sh script or install it manually."
        sh: "command -v kubeseal"

  seal:
    desc: "Seals a secret from key-value pairs. Usage: task secrets:seal NS=<ns> NAME=<name> 'KEY=VALUE'"
    vars:
      NS:
        sh: 'if [ -z "{{.NS}}" ]; then echo "Error: NS (namespace) is required." >&2; exit 1; else echo "{{.NS}}"; fi'
      NAME:
        sh: 'if [ -z "{{.NAME}}" ]; then echo "Error: NAME (secret name) is required." >&2; exit 1; else echo "{{.NAME}}"; fi'
    cmds:
      - |
        LITERAL_ARGS=""
        for arg in {{.CLI_ARGS}}; do
          LITERAL_ARGS="$LITERAL_ARGS --from-literal=$arg"
        done
        if [ -z "$LITERAL_ARGS" ]; then
          echo "Error: At least one 'KEY=VALUE' argument is required." >&2; exit 1;
        fi
        OUTPUT_DIR="{{.KUBERNETES_DIR}}/apps/{{.NS}}/secrets"
        mkdir -p "$OUTPUT_DIR"
        OUTPUT_FILE="$OUTPUT_DIR/{{.NAME}}.sealed.yaml"
        echo "Sealing secret '{{.NAME}}' into $OUTPUT_FILE..."
        kubectl create secret generic {{.NAME}} --namespace={{.NS}} $LITERAL_ARGS --dry-run=client -o yaml \
          | kubeseal --cert .sealed-secrets-public-cert.pem --format yaml > "$OUTPUT_FILE"
        echo "✅ Sealed secret written successfully."
    preconditions:
      - msg: "The public certificate .sealed-secrets-public-cert.pem does not exist. Run 'task secrets:init' first."
        sh: "test -f .sealed-secrets-public-cert.pem"