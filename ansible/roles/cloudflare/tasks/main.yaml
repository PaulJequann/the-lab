---
- name: Install Cloudflare
  when: inventory_hostname == groups['controllers'][0]
  block:
    - name: Load Cloudflare variables
      community.sops.load_vars:
        file: "{{ role_path }}/files/cloudflare-tunnel.sops.json"

    - name: Create Cloudflare namespace
      ansible.builtin.k8s:
        state: present
        namespace: cloudflare
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: cloudflare
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 30

    - name: Create Cloudflare API token secret
      ansible.builtin.k8s:
        state: present
        namespace: cloudflare
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api-token
            labels:
              app.kubernetes.io/name: cloudflare-api-token
              app.kubernetes.io/part-of: cloudflare
          type: Opaque
          stringData:
            account-tag: "{{ AccountTag }}"
            tunnel-secret: "{{ TunnelSecret }}"
            tunnel-id: "{{ TunnelID }}"
            tunnel-endpoint: "{{ Endpoint }}"

    - name: Add Cloudflare helm repo
      kubernetes.core.helm_repository:
        name: cloudflare
        repo_url: https://cloudflare.github.io/helm-charts
      register: add_repo_result
      changed_when: add_repo_result.rc == 0
    
    - name: Install Cloudflare helm chart
      kubernetes.core.helm:
        name: cloudflare
        chart_ref: cloudflare/cloudflare
        chart_repo_url: https://cloudflare.github.io/helm-charts
        release_namespace: cloudflare
        values:
          cloudflare:
            tunnelName: "{{ cloudflare_tunnel_name }}"
            tunnelId: "{{ TunnelID }}"
            secret: "{{ TunnelSecret }}"
            ingress:
              - hostname: "tunnel.{{ cloudflare_domain }}"
                service: http://web-service:80
              
              - hostname: "hello.{{ cloudflare_domain }}"
                service: hello_world
          resources:
            limits:
              cpu: 500m
              memory: 128Mi