---
# Block for Cilium installation (only on first controller)
- name: Deploy Cilium CNI
  block:
    - name: Install Kubernetes Gateway API CRDs
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
      loop:
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/refs/heads/main/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
        - https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.1/standard-install.yaml
      retries: 3
      delay: 5

    - name: Install Cilium CLI
      ansible.builtin.shell: |
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
        CLI_ARCH=amd64
        if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
        sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
      args:
        executable: /bin/bash
        creates: /usr/local/bin/cilium
      register: cilium_cli_install
      changed_when: cilium_cli_install.rc == 0

    - name: Add Cilium Helm repo
      kubernetes.core.helm_repository:
        name: cilium
        repo_url: https://helm.cilium.io

    - name: Delete existing cilium-ingress service
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Service
        name: cilium-ingress
        namespace: kube-system

    - name: Install/upgrade Cilium
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: "{{ cilium_version | default('1.17.1') }}"
        release_namespace: "{{ cilium_namespace | default('kube-system') }}"
        kubeconfig: "{{ k3s_kubeconfig_file }}"
        values:
          operator:
            replicas: 1
          kubeProxyReplacement: true
          k8sServiceHost: "10.0.10.50"
          k8sServicePort: 6443
          ipam:
            mode: cluster-pool
            operator:
              clusterPoolIPv4PodCIDRList:
                - 10.42.0.0/16
          hubble:
            relay:
              enabled: true
            ui:
              enabled: true
          ingressController:
            enabled: true
            default: true
            loadbalancerMode: shared
          gatewayAPI:
            enabled: true
          loadBalancer:
            algorithm: maglev
            serviceTopology: true
          l2announcements:
            enabled: false
        state: present
        wait: true
        timeout: "5m"
        atomic: true
      register: cilium_install

    - name: Assert Cilium is deployed
      ansible.builtin.assert:
        that:
          - cilium_install.status.status is defined
          - cilium_install.status.status == "deployed"
        fail_msg: "Cilium Helm release not deployed. Status: {{ cilium_install.status | default('unknown') }}"

    - name: Wait for Cilium DaemonSet to be ready
      kubernetes.core.k8s_info:
        kind: DaemonSet
        namespace: "{{ cilium_namespace | default('kube-system') }}"
        name: cilium
        kubeconfig: "{{ k3s_kubeconfig_file }}"
      register: ds_info
      until: >
        ds_info.resources | length > 0 and
        ds_info.resources[0].status.numberReady == ds_info.resources[0].status.desiredNumberScheduled
      retries: 30
      delay: 10

    - name: Verify Cilium Ingress service exists
      kubernetes.core.k8s_info:
        kind: Service
        name: cilium-ingress
        namespace: "{{ cilium_namespace | default('kube-system') }}"
        kubeconfig: "{{ k3s_kubeconfig_file }}"
      register: ingress_service

    - name: Create Cilium Ingress service if missing
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ k3s_kubeconfig_file }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: cilium-ingress
            namespace: "{{ cilium_namespace | default('kube-system') }}"
            labels:
              app.kubernetes.io/name: cilium-ingress
              app.kubernetes.io/part-of: cilium
          spec:
            selector:
              k8s-app: cilium
            ports:
              - name: http
                port: 80
                protocol: TCP
                targetPort: 80
              - name: https
                port: 443
                protocol: TCP
                targetPort: 443
            type: LoadBalancer
      when: ingress_service.resources | length == 0

    - name: Wait for Cilium Ingress service to get external IP
      kubernetes.core.k8s_info:
        kind: Service
        name: cilium-ingress
        namespace: "{{ cilium_namespace | default('kube-system') }}"
        kubeconfig: "{{ k3s_kubeconfig_file }}"
      register: ingress_service_ip
      until: >
        ingress_service_ip.resources | length > 0 and
        ingress_service_ip.resources[0].status.loadBalancer.ingress is defined and
        ingress_service_ip.resources[0].status.loadBalancer.ingress | length > 0
      retries: 15
      delay: 10

    - name: Check if Cilium IngressClass exists
      kubernetes.core.k8s_info:
        api_version: networking.k8s.io/v1
        kind: IngressClass
        name: cilium
        kubeconfig: "{{ k3s_kubeconfig_file }}"
      register: cilium_ingress_class

    - name: Delete Cilium IngressClass if it exists with wrong parameters
      kubernetes.core.k8s:
        state: absent
        api_version: networking.k8s.io/v1
        kind: IngressClass
        name: cilium
        kubeconfig: "{{ k3s_kubeconfig_file }}"
      when: cilium_ingress_class.resources | length > 0

    - name: Create Cilium IngressClass with correct parameters
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ k3s_kubeconfig_file }}"
        definition:
          apiVersion: networking.k8s.io/v1
          kind: IngressClass
          metadata:
            name: cilium
            annotations:
              ingressclass.kubernetes.io/is-default-class: "true"
          spec:
            controller: cilium.io/ingress-controller
            parameters:
              apiGroup: cilium.io
              kind: CiliumIngressConfig
              name: cilium-ingress-config

  environment:
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"
  when: inventory_hostname == groups['controllers'][0]