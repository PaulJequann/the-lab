---
- name: Install ArgoCD
  when: inventory_hostname == groups['controllers'][0]
  block:
    - name: Load encrypted variables
      community.sops.load_vars:
        file: "{{ role_path }}/defaults/main.sops.yaml"

    - name: Add Argo Helm repository
      kubernetes.core.helm_repository:
        name: argo
        repo_url: https://argoproj.github.io/argo-helm
        state: present

    - name: Check if ArgoCD Helm release exists and is deployed
      kubernetes.core.helm_info:
        name: argocd
        namespace: argocd
      register: argocd_helm_info
      ignore_errors: yes

    #TODO this is not working, still redeploys ArgoCD
    - name: Set fact for ArgoCD installation needed
      set_fact:
        argocd_install_needed: >-
          {{ 
            argocd_helm_info.failed | default(false) or
            argocd_helm_info.releases is not defined or 
            argocd_helm_info.releases | length == 0 or 
            (argocd_helm_info.releases | length > 0 and argocd_helm_info.releases[0].status != 'deployed') or
            argocd_helm_info.releases[0].chart_version != argocd_chart_version
          }}

    - name: Install ArgoCD using Helm
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        chart_version: "{{ argocd_chart_version }}"
        namespace: "{{ argocd_namespace }}"
        create_namespace: true
        values: "{{ lookup('template', 'argocd-helm-values.yaml.j2') | from_yaml }}"
      when: argocd_install_needed | bool
    
    - name: Create age key secret for helm-secrets
      when: lookup('env', 'SOPS_AGE_KEY_FILE') | length > 0
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ helm_secrets_age_key_secret_name }}"
            namespace: "{{ helm_secrets_age_key_secret_namespace }}"
          type: Opaque
          data:
            key.txt: "{{ lookup('file', lookup('env', 'SOPS_AGE_KEY_FILE')) | b64encode }}"
    
    - name: Wait for ArgoCD server to be ready
      ansible.builtin.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: argocd
        name: argocd-server
      register: argocd_server
      until:
        - argocd_server.resources is defined
        - argocd_server.resources | length > 0
        - argocd_server.resources[0].status.availableReplicas is defined
        - argocd_server.resources[0].status.availableReplicas > 0
        - argocd_server.resources[0].status.availableReplicas == argocd_server.resources[0].status.replicas
      retries: 15
      delay: 10

    - name: Check for ArgoCD server deployment
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: argocd
        name: argocd-server
      register: argocd_server_deployment
      failed_when: argocd_server_deployment.resources | length == 0
    
    - name: Apply ArgoCD Ingress
      ansible.builtin.k8s:
        state: present
        namespace: argocd
        definition: "{{ lookup('template', 'argocd-ingress.yaml.j2') | from_yaml }}"
    
    # First, get the current ConfigMap to check if we need to make changes
    - name: Get current ArgoCD command params ConfigMap
      kubernetes.core.k8s_info:
        api_version: v1
        kind: ConfigMap
        name: argocd-cmd-params-cm
        namespace: argocd
      register: argocd_cmd_params
      when: 
        - argocd_insecure is defined

    # Determine if we need to make changes
    - name: Set fact for ConfigMap change needed
      set_fact:
        insecure_mode_change_needed: >-
          {{ 
            argocd_insecure | bool and 
            (
              argocd_cmd_params.resources | length == 0 or 
              argocd_cmd_params.resources[0].data is not defined or
              argocd_cmd_params.resources[0].data['server.insecure'] is not defined or
              argocd_cmd_params.resources[0].data['server.insecure'] != 'true'
            )
          }}
      when: 
        - argocd_insecure is defined

    # Apply the ConfigMap changes if needed
    - name: Configure ArgoCD to accept HTTP (insecure mode)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: argocd-cmd-params-cm
            namespace: argocd
            labels:
              app.kubernetes.io/name: argocd-cmd-params-cm
              app.kubernetes.io/part-of: argocd
          data:
            server.insecure: "true"
      when: 
        - argocd_insecure is defined
        - argocd_insecure | bool
      register: config_map_result

    # Restart only if changes were made
    - name: Restart ArgoCD server to apply changes
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        namespace: argocd
        label_selectors:
          - app.kubernetes.io/name=argocd-server
      when: 
        - argocd_insecure is defined
        - argocd_insecure | bool
        - insecure_mode_change_needed | bool or config_map_result.changed