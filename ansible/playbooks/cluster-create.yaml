---
- name: Install K3s Cluster
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check if node is reachable
      ping:
      
    - name: Get facts about nodes
      setup:

  tasks:
    - name: Include pre-configuration role
      include_role:
        name: pre
    
    - name: Include K3s role for control plane nodes
      include_role:
        name: k3s
        
    - name: Include Cilium role
      include_role:
        name: cilium

    - name: Include ArgoCD role
      include_role:
        name: argocd

  post_tasks:
    - name: Local configuration
      when: inventory_hostname == groups['controllers'][0]
      run_once: true
      block:
        - name: Create local .kube directory
          ansible.builtin.file:
            path: "{{ lookup('ansible.builtin.env', 'HOME') + '/.kube' }}"
            mode: 0755
            state: directory
          delegate_to: localhost
          become: false

        - name: Get Kubernetes config file
          run_once: true
          ansible.builtin.slurp:
            src: /etc/rancher/k3s/k3s.yaml
          register: kubeconfig_base64

        - name: Write Kubernetes config file to .kube with the correct cluster address
          ansible.builtin.copy:
            content: "{{ kubeconfig_base64.content | b64decode | replace('127.0.0.1', control_plane_endpoint) }}"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') + '/.kube' + '/config' }}"
            mode: 0600
          delegate_to: localhost
          become: false

        - name: Write Kubernetes config file to project directory with the correct cluster address
          ansible.builtin.copy:
            content: "{{ kubeconfig_base64.content | b64decode | replace('127.0.0.1', control_plane_endpoint) }}"
            dest: "{{ playbook_dir }}/../../kubeconfig"
            mode: 0600
          delegate_to: localhost
          become: false
