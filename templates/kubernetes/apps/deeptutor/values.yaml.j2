---
# Values for bjw-s app-template chart
{{helmchart_template_name}}:
  controllers:
    deeptutor:
      containers:
        app:
          image:
            repository: {{deeptutor_image_repository}}
            tag: {{deeptutor_image_tag}}
            pullPolicy: Always
          env:
            TZ: America/New_York
            NEXT_PUBLIC_API_BASE_EXTERNAL: "https://{{deeptutor_domain}}"
            NEXT_PUBLIC_API_BASE: "https://{{deeptutor_domain}}"
            # LLM Configuration
            LLM_BINDING: "{{ deeptutor_llm_binding }}"
            LLM_MODEL: "{{ deeptutor_llm_model }}"
            LLM_BINDING_HOST: "{{ deeptutor_llm_host }}"
            DISABLE_SSL_VERIFY: "{{ deeptutor_disable_ssl_verify }}"
            # Embedding Configuration
            EMBEDDING_BINDING: "{{ deeptutor_embedding_binding }}"
            EMBEDDING_MODEL: "{{ deeptutor_embedding_model }}"
            EMBEDDING_BINDING_HOST: "{{ deeptutor_embedding_host }}"
            EMBEDDING_DIM: "{{ deeptutor_embedding_dim }}"
            EMBEDDING_MAX_TOKENS: "{{ deeptutor_embedding_max_tokens }}"
            # Service Ports
            BACKEND_PORT: "{{ deeptutor_backend_port }}"
            FRONTEND_PORT: "{{ deeptutor_frontend_port }}"
            # Logging
            RAG_TOOL_MODULE_LOG_LEVEL: "{{ deeptutor_rag_log_level }}"
            # API Keys from Sealed Secret
            LLM_BINDING_API_KEY:
              valueFrom:
                secretKeyRef:
                  name: deeptutor-secrets
                  key: LLM_BINDING_API_KEY
            EMBEDDING_BINDING_API_KEY:
              valueFrom:
                secretKeyRef:
                  name: deeptutor-secrets
                  key: EMBEDDING_BINDING_API_KEY
            PERPLEXITY_API_KEY:
              valueFrom:
                secretKeyRef:
                  name: deeptutor-secrets
                  key: PERPLEXITY_API_KEY
          probes:
            liveness:
              enabled: false
            readiness:
              enabled: false
            startup:
              enabled: false
      pod:
        securityContext:
          fsGroup: 1000

  service:
    app:
      controller: deeptutor
      ports:
        http:
          port: {{deeptutor_frontend_port}}
        backend:
          port: {{deeptutor_backend_port}}

  ingress:
    app:
      enabled: true
      className: cilium
      annotations:
        cert-manager.io/cluster-issuer: {{cert_manager_issuer_name}}
      hosts:
        - host: {{deeptutor_domain}}
          paths:
            - path: /api
              pathType: Prefix
              service:
                identifier: app
                port: backend
            - path: /
              pathType: Prefix
              service:
                identifier: app
                port: http
      tls:
        - secretName: deeptutor-tls
          hosts:
            - {{deeptutor_domain}}

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: nfs-csi
      accessMode: ReadWriteOnce
      size: {{deeptutor_storage_size}}
      globalMounts:
        - path: /app/data
    config:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /app/config
          readOnly: false
